{% load static %}
{% load customfilter %}
{% with ""|contact as contact %}
{% with contact.0 as contact %}
</div>
<footer id="footerid" style="margin-top: 6rem;">
  <style>
  .mb-2, .my-2 {
    margin-bottom: .5rem!important;
}.ml-1, .mx-1 {
    margin-left: .5rem!important;
}.mr-1, .mx-1 {
    margin-right: .10rem!important;
}
.footer-wrap{
  font-size: 18px!important;
}
.footer-heading{
  font-size: 20px!important;;
}

  </style>
      <div class="footer-wrap">
        <div class="container">
          <div class="row">
            <div class="col-md-4 col-sm-6">
              <div class="footer-heading">Useful Links</div>
              <ul class="footer-nav">
                <li><a target="_blank" href="https://www.incometax.gov.in/iec/foportal
                  ">E-filing portal of Income Tax dept.</a></li>
                <li><a target="_blank" href="https://services.gst.gov.in/services/login">GST portal</a></li>
                <li><a target="_blank" href="https://ewaybillgst.gov.in/login.aspx">E-way bill</a></li>
                <li><a target="_blank" href="https://www.cbic.gov.in/"> CBIC</a></li>
              </ul>
            </div>
            <div class="col-md-4 col-sm-6 middle">
              <div class="footer-heading">Quick Links</div>
              <ul class="footer-nav">
                <li><a href="#">Corporate Services</a></li>
                <li> <a href="#">Audit</a></li>
                <li><a href="#">Corporate Finance</a></li>
                <li><a href="#">Services for Non-Residents</a></li>
                <li><a href="#">Accounting Services</a></li>
                <li><a href="#">Business Process Outsourcing</a></li>
              </ul>
            </div>
            <div class="col-md-4 col-sm-6">
              <div class="footer-heading">Connect With Us</div>
              <ul class="call-ad">
                <li>
                  <div><i class="fa fa-map-marker"></i><span>{{contact.address}}</span></div>
                </li>
                <li>
                  <div><i class="fa fa-phone"></i><span>{{contact.otherPhones}}</span></div>
                </li>

                <li>
                  <div><i class="fa fa-envelope"></i><span>{{contact.email}}</span></div>
                </li>
              </ul>
             
              <div class="d-flex mt-0" >
                <div class="text-light "><a class="mb-2 p-3   text-light" href=""><i class=" fa fa-facebook"></i></a></div>
                <div class="text-light "><a class="mb-2  p-3  text-light" href=""><i class=" fa fa-instagram"></i></a></div>
                <div class="text-light "><a class="mb-2  p-3  text-light" href=""><i class="fa fa-pinterest-p"></i></a></div>
                <div class="text-light "><a class="mb-2   p-3 text-light" href=""><i class="fa fa-linkedin"></i></a></div>
                
              </div>
            </div>
          </div>
          <div class="footer-service">
            <div class="copyright" style="font-size: 15px;">© 2021 Cyberflax PVT. LTD &amp; . All Rights Reserved</div>
          </div>
        </div>
      </div>
      
    </footer>
  <script src="https://kit.fontawesome.com/ad22a78509.js" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"
    integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF"
    crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js"
    integrity="sha512-XtmMtDEcNz2j7ekrtHvOVR4iwwaD6o/FUJe6+Zq+HgcCsk3kj4uSQQR8weQ2QVj1o0Pk6PwYLohm206ZzNfubg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script type="text/javascript">
    $('.parent').slick({
      dots: false,
      arrows: true,
      infinite: true,
      autoplay: true,
      speed: 2000,
      slidesToShow: 1,
      slidesToScroll: 1,
      responsive: [
        {
          breakpoint: 1024,
          settings: {
            slidesToShow: 1,
            slidesToScroll: 1,
            infinite: true,
            dots: false,
            arrows: true
          }
        },
        {
          breakpoint: 600,
          settings: {
            slidesToShow: 1,
            slidesToScroll: 1,
            arrows: true
          }
        },
        {
          breakpoint: 480,
          settings: {
            slidesToShow: 1,
            slidesToScroll: 1
          }
        }
      ]
    });
    function readURL(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();

        reader.onload = function (e) {
            $('#blah').attr('src', e.target.result);
        }

        reader.readAsDataURL(input.files[0]);
        $("#imgpreview").show()
    }
}

$("#filefield").change(function(){
    readURL(this);
});
  </script>
  
  <script src="{% static 'js/main.js' %}"></script>
  <script>
    {% comment %} $('#sendmsg').submit(function(event) {
   var formData =  $('#sendmsg').serializeArray().reduce(function(obj, item) {
   obj[item.name] = item.value;
   return obj;
   }, {});

   $.ajax({
       type: 'POST',
       url: "{% url 'sendmsg'  %}",
       data: formData,
       encode: true
   })
   .done(function(data) {
       $("input[name=message]").val('')
       $("input[name=message]").focus()
   });
   
event.preventDefault();
event.preventDefault();
}) {% endcomment %}

(function(){
    var form = document.getElementById('sendmsg');
    var fileSelect = document.getElementById('filefield');
    var uploadButton = document.getElementById('submit');
    var statusDiv = document.getElementById('status');
    if (form!=null){
    form.onsubmit = function(event) {
        event.preventDefault();

        statusDiv.innerHTML = 'Uploading . . . ';

        // Get the files from the input
        var files = fileSelect.files;

        // Create a FormData object.
        var formData = new FormData();
        $('#sendmsg').serializeArray().reduce(function(obj, item) {
        formData.append(item.name, item.value);
   return obj;
   }, {});
        
        //Grab only one file since this script disallows multiple file uploads.
        var file = files[0]; 

        // //Check the file type.
        // if (!file.type.match('image.*')) {
        //     statusDiv.innerHTML = 'You cannot upload this file because it’s not an image.';
        //     return;
        // }

        // if (file.size >= 2000000 ) {
        //     statusDiv.innerHTML = 'You cannot upload this file because its size exceeds the maximum limit of 2 MB.';
        //     return;
        // }

         // Add the file to the AJAX request.
        if(file != undefined){
        formData.append('myfile', file, file.name);
      }
        // Set up the request.
        var xhr = new XMLHttpRequest();

        // Open the connection.
        xhr.open('POST', '{% url 'sendmsg'  %}', true);


        // Set up a handler for when the task for the request is complete.
        xhr.onload = function () {
          if (xhr.status === 200) {
           $("input[name=message]").val('')
           $("input[name=message]").focus()
           $("#filefield").val(null)
           $("#imgpreview").hide()
            ws.send("sent")
          }
        };

        // Send the data.
        xhr.send(formData);
    }
    }
})();

    var socket = false
   function getsms () {
   data = document.getElementsByClassName("usermessages")
   var xhttp = new XMLHttpRequest()
   xhttp.open('GET',"{% url 'getmsg' %}?len="+data.length.toString(),true)
   xhttp.send()
   xhttp.onreadystatechange = function(){
       if(xhttp.readyState==4 && xhttp.status==200){
           data = xhttp.responseText
           console.log(data)
               data = JSON.parse(data)
              if (data != "updated"){
               if(!$('.chatbox').hasClass('active') && data[1]>0){
                 $("#unreadmessage").html(data[1])
                 console.log("showing nortification .....")
                ShowNortification("Hey !",`you have ${data[1]} new messages from Kirnaaz`,"{% static 'images/favicon.jpeg' %}")
               };
               updatedmsg(data[0])
               var objDiv = document.getElementById("chat-content");
            objDiv.scrollTop = objDiv.scrollHeight;
           }
       }
   }
   if(!socket){
   setTimeout(getsms, 1500);
   }
  //  setTimeout(getsms, 1500); // try again in 1500 milliseconds
   }
   async function ShowNortification(title,body,icon){
    let permission = await Notification.requestPermission();
    const greeting = new Notification(title,{
        body: body,
        icon: icon
      });
    }
    function show() {
      var xhttp = new XMLHttpRequest()
      $("#unreadmessage").html(0)
      xhttp.open('GET',"{% url 'readbyuser' %}",true)
      xhttp.send()
      $('.chatbox').addClass('active');
    }
    $('.close-menu').click(() => {
      $('.chatbox').removeClass('active');
    });
    function clearfile(){
        $("#filefield").val(null);
        $("#imgpreview").toggle();
    }

function updatedmsg(msgs){
    if (msgs.length>0){
        for(i=0;i<msgs.length;i++){
          // console.log("hello")
            if (msgs[i]['msgtoadmin']==true){
                var msgstr = `
                
                         <div class="media media-chat media-chat-reverse usermessages">
                              <div class="media-body">
                                
                 `
                 if (msgs[i]['convofiles__file']!= null){
                   msgstr += `<div class="" style="border: solid 5px;
        border-block-color: revert;
        border-color: #e77b20;
        border-radius:20;"><img src="/media/${msgs[i]['convofiles__file']}" alt="" style="
        width: 200px;
    height: 154px;
    object-fit: cover;"  ></div>`
                 }
                 msgstr+= `      <p>${msgs[i]['msg']}</p>
                              </div>
                          </div>`
            }
            else{
                var msgstr = ` <div class="media media-chat usermessages"> <img class="avatar" src="https://img.icons8.com/color/36/000000/administrator-male.png" alt="...">
                              <div class="media-body">`
                 if (msgs[i]['convofiles__file']!= null){
                   msgstr += `<img src="/media/${msgs[i]['convofiles__file']}" alt="" style="    
                   width: 200px;
                    height: 154px;
                    object-fit: cover;">`
                 }
                 msgstr+= `      <p>${msgs[i]['msg']}</p>
                              </div>
                          </div>`
            }
            msgstr = msgstr.replace("<p></p>",'')

            $("#chat-content").append(msgstr)
            var objDiv = document.getElementById("chat-content");
            objDiv.scrollTop = objDiv.scrollHeight;
        }
    }
}

{% if request.is_secure %}
  const url = "wss://{{request.get_host}}/ws/chat/{{user.username}}"
  {% else %}
  const url = "ws://{{request.get_host}}/ws/chat/{{user.username}}"
  {% endif %}
  console.log("{{ request.is_secure }}")
    const ws = new WebSocket(url)
    const messageDiv = document.getElementById("showmessages")
    const online = document.getElementById("onlineuser")
    ws.onopen = function(event){
        console.log("connetion is opend")

    }
    ws.onmessage = function(event){
        console.log("message is get")
        console.log(event)
        socket=true
        getsms()  
    }
    ws.onclose = function(event){
      socket=false
        console.log("connetion is closed")
        // getsms()
    }
    getsms()
    
</script>

</body>

</html>
{% endwith %}{% endwith %}